ARG IMG_NAME=${$IMG_NAME:-gradle}
ARG IMG_TAG=${$IMG_TAG:-latest}

FROM ${IMG_NAME}:${IMG_TAG}

ARG IMG_NAME=${IMG_NAME:-debian}
ARG IMG_TAG=${IMG_TAG:-latest}
ARG TIMEZONE=${TIMEZONE:-UTC}

ARG DEBIAN_FRONTEND=noninteractive

ENV TZ="${TIMEZONE}"

RUN apt-get -qq -y update && apt-get -qq -y upgrade \
    && apt-get -qq -y install \
        vim \
        curl \
        wget \
        apt-transport-https \
        sudo \
        git \
        tzdata \
        bash \
        maven \ 
        zip \
    && ln -fs /usr/share/zoneinfo/${TIMEZONE} /etc/localtime \
    && dpkg-reconfigure -f noninteractive tzdata

# Intall Jenkins
RUN wget -O /etc/apt/keyrings/jenkins-keyring.asc \
    https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key \
    && echo "deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc]" \
        https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
        /etc/apt/sources.list.d/jenkins.list > /dev/null \
    && apt-get update \
    && apt-get -qq -y install fontconfig jenkins

# Create developer user
RUN addgroup --gid ${GID} ${USERNAME} \
    && adduser --uid ${UID} --gid ${GID} --disabled-password --gecos "${COMMENT}" --shell ${SHELL} ${USERNAME} \
    && usermod -aG sudo ${USERNAME} \
    && echo "${USERNAME} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/casper

# Install Oracle JDK
RUN curl -o /tmp/jdk-${JDK_VERSION}_linux-x64_bin.deb https://download.oracle.com/java/${JDK_VERSION}/latest/jdk-${JDK_VERSION}_linux-x64_bin.deb \
    && apt-get -qq -y install /tmp/jdk-${JDK_VERSION}_linux-x64_bin.deb \
    && rm /tmp/jdk-${JDK_VERSION}_linux-x64_bin.deb \
    && ln -s $(dirname $(dirname $(readlink -f $(which java)))) /usr/lib/jvm/jdk-${JDK_VERSION}

# Install Gradle
RUN wget https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip -O /tmp/gradle-${GRADLE_VERSION}-bin.zip \
    && unzip -d /opt/gradle /tmp/gradle-${GRADLE_VERSION}-bin.zip \
    && rm /tmp/gradle-${GRADLE_VERSION}-bin.zip

# Set environment variables
ENV GRADLE_HOME=/opt/gradle/gradle-${GRADLE_VERSION}
ENV PATH=${PATH}:${GRADLE_HOME}/bin 
ENV JAVA_HOME=/usr/lib/jvm/jdk-${JDK_VERSION}
ENV PATH=${PATH}:${JAVA_HOME}/bin

# Set user and working directory
USER ${USERNAME}
WORKDIR /home/${USERNAME}
